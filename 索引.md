title: 索引
categories: mysql
---


### 什么是索引和索引的作用

**索引是一个单独的、物理的数据库结构，它是某个表中一列或若干列值的集合和相应的指向表中物理标识这些值的数据页的逻辑指针清单**

索引用于快速找出在某个列中有一特定值的行，不使用索引，MySQL必须从第一条记录开始读完整个表，直到找出相 关的行，表越大，查询数据所花费的时间就越多，如果表中查询的列有一个索引，MySQL能够快速到达一个位置去搜索数据文件，而不必查看所有数据，那么将会节省很大一部分时间

### 聚集索引和非聚集索引

**聚集索引和非聚集索引的根本区别是表记录的排列顺序和与索引的排列顺序是否一致**，其实理解起来非常简单，还是举字典的例子：如果按照拼音查询，那么都是从a-z的，是具有连续性的，a后面就是b，b后面就是c， 聚集索引就是这样的，他是和表的物理排列顺序是一样的，例如有id为聚集索引，那么1后面肯定是2,2后面肯定是3，所以说这样的搜索顺序的就是聚集索引。非聚集索引就和按照部首查询是一样是，可能按照偏房查询的时候，根据偏旁‘弓’字旁，索引出两个汉字，张和弘，但是这两个其实一个在100页，一个在1000页，（这里只是举个例子），他们的索引顺序和数据库表的排列顺序是不一样的，这个样的就是非聚集索引

### 为什么要使用索引

#### InnoDB页结构示意图

![](https://www.itcodemonkey.com/data/upload/portal/20190228/1551343343178878.jpg)

#### 存储方式

![](https://www.itcodemonkey.com/data/upload/portal/20190228/1551343343125435.jpg)

**每个数据页用双向链表连接，页中的数据使用单向链表存储，数据页的大小为16KB**，每个数据页都会为存储在它里边儿的记录生成一个页目录，在通过主键查找某条记录的时候可以在页目录中使用二分法快速定位到对应的槽，然后再遍历该槽对应分组中的记录即可快速找到指定的记录，如果以非主键列作为搜索条件，只能从最小记录开始依次遍历单链表中的每条记录。

#### B+树

![](http://img.mp.sohu.com/upload/20170713/358025867be14bb99bf8806b98e774d9_th.png)

以主键索引为例，使用记录主键值的大小进行记录和页的排序，中间节点记录了下层节点主键最大值，如此往上迭代，组成一个B+树，其中只有叶子节点存有数据，其余中间节点仅仅只是索引，不带有数据，在查询的时候，B+树会自顶向下逐层查找节点，直到找到匹配的叶子节点。(相当于根据指定字段，为所有数据页生成一个目录，就可以根据某个字段快速定位数据所在的数据页)

https://mp.weixin.qq.com/s?__biz=MzIxNTQ3NDMzMw==&mid=2247483701&idx=1&sn=bd229dd584f51ef4fe545d44ad8cdbf9&chksm=979688c7a0e101d1b5c752094013b78f5bd50ab905257ba82149d85d35ea07aba1a15b0e52b4#rd

https://www.sohu.com/a/156886901_479559

### 索引的分类

1. 普通索引index :加速查找

2. 唯一索引

- 主键索引：primary key ：加速查找+约束（不为空且唯一）
- 唯一索引：unique：加速查找+约束 （唯一）
3. 联合索引
- primary key(id,name):联合主键索引
- unique(id,name):联合唯一索引
- index(id,name):联合普通索引
4. 全文索引fulltext :用于搜索很长一篇文章的时候，效果最好。
5. 空间索引spatial :了解就好，几乎不用

### 索引的运用

#### 普通索引

这是最基本的索引，它没有任何限制。它有以下几种创建方式：

`CREATE INDEX 索引名 ON 表(字段(长度))`

`ALTER TABLE 表 ADD INDEX 索引名(字段(长度))`

在建表时`INDEX 表 (字段(长度))`

#### 唯一索引

主键就是唯一索引的一种，主键要求建表时指定，一般用auto_increment列，关键字是primary key。它与前面的普通索引类似，不同的就是：索引列的值必须唯一，但允许有空值。如果是组合索引，则列值的组合必须唯一。它有以下几种创建方式：

`CREATE UNIQUE INDEX 索引名 ON 表(字段(长度))`

`ALTER TABLE 表 ADD UNIQUE [索引名](字段(长度))

在建表时`UNIQUE [索引名] (字段(长度))`

#### 多列索引

`CREATE INDEX 索引名 ON 表(字段(长度),字段(长度))`

`ALTER TABLE 表 ADD INDEX [索引名](字段(长度),字段(长度))`

在建表时`INDEX [索引名] (字段(长度),字段(长度))`


### 适用情况

1. 经常需要搜索的列上，可以加快搜索的速度
2. 作为主键的列上，强制该列的唯一性和组织表中数据的排列结构
3. 经常用在连接的列上，这些列主要是一些外键，可以加快连接的速度
4. 经常需要根据范围进行搜索的列上创建索引，因为索引已经排序，其指定的范围是连续的
5. 经常需要排序的列上创 建索引，因为索引已经排序，这样查询可以利用索引的排序，加快排序查询时间
6. 经常使用在WHERE子句中的列上面创建索引，加快条件的判断速度

### 优缺点

#### 优点

- 通过创建唯一性索引，可以保证数据库表中每一行数据的唯一性
- 可以大大加快数据的检索速度，这也是创建索引的最主要的原因
- 可以加速表和表之间的连接，特别是在实现数据的参考完整性方面特别有意义
- 在使用分组和排序子句进行数据检索时，同样可以显著减少查询中分组和排序的时间
- 通过使用索引，可以在查询的过程中，使用优化隐藏器，提高系统的性能

#### 缺点

- 创建索引和维护索引要耗费时间，这种时间随着数据量的增加而增加
- 索引需要占物理空间，除了数据表占数据空间之外，每一个索引还要占一定的物理空间，如果要建立聚簇索引， 那么需要的空间就会更大
- 当对表中的数据进行增加、删除和修改的时候，索引也要动态的维护，这样就降低了数据的维护速度

### 补充

1. 索引的最左匹配特性（即从左往右匹配）：如果以a,b,c三个字段建立多列索引，则在使用a,ab,abc作为检索条件时都能使用这个多列索引
2. 索引字段要尽量的小：通过上面的分析，我们知道IO次数取决于b+数的高度h，假设当前数据表的数据为N，每个磁盘块的数据项的数量是m，则有h=㏒(m+1)N，当数据量N一定的情况下，m越大，h越小；而m = 磁盘块的大小 / 数据项的大小，磁盘块的大小也就是一个数据页的大小，是固定的，如果数据项占的空间越小，数据项的数量越多，树的高度越低。这就是为什么每个数据项，即索引字段要尽量的小，比如int占4字节，要比bigint8字节少一半。这也是为什么b+树要求把真实的数据放到叶子节点而不是内层节点，一旦放到内层节点，磁盘块的数据项会大幅度下降，导致树增高。当数据项等于1时将会退化成线性表
3. mysql会一直向右匹配直到遇到范围查询(>、<、between、like)就停止匹配，比如a = 1 and b = 2 and c > 3 and d = 4 如果建立(a,b,c,d)顺序的索引，d是用不到索引的，如果建立(a,b,d,c)的索引则都可以用到，a,b,d的顺序可以任意调整
4. =和in可以乱序，比如a = 1 and b = 2 and c = 3 建立(a,b,c)索引可以任意顺序，mysql的查询优化器
会帮你优化成索引可以识别的形式
5. MySQL只对一下操作符才使用索引：<,<=,=,>,>=,between,in,以及某些时候的like(不以通配符%或_开头的情形)
6. select from users where YEAR(adddate)<2007，将在每个行上进行运算，这将导致索引失效而进行全表扫描，因此我们可以改成：select from users where adddate<’2007-01-01′
7. 要想使用or，又想让索引生效，只能将or条件中的每个列都加上索引
8. 如果列类型是字符串，那一定要在条件中将数据使用引号引用起来,否则不使用索引